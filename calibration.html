<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calibration &mdash; Tiliqua  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/platformpicker.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/platformpicker.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Electrical Design" href="hardware_design.html" />
    <link rel="prev" title="Trigonometry / CORDIC" href="dsp/cordic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Tiliqua
              <img src="_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart/tlq_module.html">Tiliqua Module [<code class="docutils literal notranslate"><span class="pre">TLQ-MODULE</span></code>]</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart/tlq_screen.html">Tiliqua Screen [<code class="docutils literal notranslate"><span class="pre">TLQ-SCREEN</span></code>]</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart/tlq_expander.html">Expander / Euro-PMOD [<code class="docutils literal notranslate"><span class="pre">TLQ-EXPANDER</span></code>]</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart/tlq_soldiercrab.html">Soldiercrab SoM [<code class="docutils literal notranslate"><span class="pre">TLQ-SOLDIERCRAB</span></code>]</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_flashing.html">Building and Flashing</a></li>
<li class="toctree-l1"><a class="reference internal" href="audio_bitstreams.html">Tutorial 1: Audio cores (<code class="docutils literal notranslate"><span class="pre">top.dsp</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_dsp.html">Tutorial 2: DSP blocks (<code class="docutils literal notranslate"><span class="pre">tiliqua.dsp</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="beamrace_video.html">Tutorial 3: Video cores (<code class="docutils literal notranslate"><span class="pre">top.beamrace</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpu_bitstreams.html">Tutorial 4: SoC/CPU bitstreams</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootloader.html">Bootloader</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="dsp/index.html">DSP Library</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Calibration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calibrating-the-adcs-dacs">Calibrating the ADCs/DACs</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hardware_design.html">Electrical Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware_changes.html">Changelist</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Keep Updated</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="foss_funding.html">Funding &amp; Open Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="devlog/index.html">Development Blog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://apfaudio.github.io/tiliqua-webflash/">Tiliqua Webflasher</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.crowdsupply.com/apfaudio/tiliqua">Tiliqua on Crowd Supply</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apfaudio/tiliqua">Tiliqua on GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apf.audio/">Homepage (apf.audio)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Tiliqua</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Calibration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/calibration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="calibration">
<h1>Calibration<a class="headerlink" href="#calibration" title="Link to this heading"></a></h1>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading"></a></h2>
<p>To support eurorack-level control voltages (CV), all inputs and outputs are DC-coupled. Audio codecs (such as the AK4619VN used here) are usually not designed for DC-coupled operation, which means that they often have quite large DC zero offsets and scaling terms compared to instrumentation converters.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Without any calibration at all, the inputs and outputs will should have an error &lt; 150mV or so across the range. Most examples will deal with this fine, however if you are driving or being driven by Eurorack V/oct tunings, 1 semitone is in the order 80mV. So, if you need to be pitch-perfect, calibration is worthwhile.</p>
</div>
<p>To reduce the tracking error, each input and output supports independent DC offset and scale correction factors:</p>
<ul class="simple">
<li><p>For input ADCs, <code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">=</span> <span class="pre">A</span> <span class="pre">*</span> <span class="pre">I</span> <span class="pre">+</span> <span class="pre">B</span></code>, where <code class="docutils literal notranslate"><span class="pre">i</span></code> is the calibrated input, <code class="docutils literal notranslate"><span class="pre">I</span></code> is the raw ADC count and <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code> are correction factors.</p></li>
<li><p>For output DACs, <code class="docutils literal notranslate"><span class="pre">O</span> <span class="pre">=</span> <span class="pre">C</span> <span class="pre">*</span> <span class="pre">o</span> <span class="pre">+</span> <span class="pre">D</span></code>, where <code class="docutils literal notranslate"><span class="pre">o</span></code> is the desired output, <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code> are correction factors, and <code class="docutils literal notranslate"><span class="pre">O</span></code> is the raw DAC count.</p></li>
</ul>
<p>Note that internally, the correction algorithm for inputs and outputs is identical. At the moment, audio samples are 16-bit fixed-point (shorthand <code class="docutils literal notranslate"><span class="pre">ASQ</span></code> in the code) with a range from <code class="docutils literal notranslate"><span class="pre">-1..1</span></code> where (when calibrated) <code class="docutils literal notranslate"><span class="pre">+1</span> <span class="pre">==</span> <span class="pre">+8.192V</span></code> (i.e 4 raw counts per mV). Both input and output sides can support wider voltage ranges, however this is currently what the codebase uses everywhere, and wide enough for most purposes.</p>
<p>All correction factors are stored as 18-bit fixed-point numbers with a range <code class="docutils literal notranslate"><span class="pre">-4..4</span></code>. Usually the scaling correction factors are close to <code class="docutils literal notranslate"><span class="pre">1</span></code>, and the zeroing correction factors are close to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</section>
<section id="calibrating-the-adcs-dacs">
<h2>Calibrating the ADCs/DACs<a class="headerlink" href="#calibrating-the-adcs-dacs" title="Link to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/calibration.jpg"><img alt="_images/calibration.jpg" src="_images/calibration.jpg" style="width: 694px;" /></a>
<p>Pictured above, the <code class="docutils literal notranslate"><span class="pre">selftest</span></code> bitstream provides a semi-automated way of performing ADC/DAC calibration.
In short, the process is as follows:</p>
<ul>
<li><p>Disconnect all jacks. Power up Tiliqua, select <code class="docutils literal notranslate"><span class="pre">selftest</span></code> bitstream, ensure startup report is healthy.</p></li>
<li><p>Switch to the <code class="docutils literal notranslate"><span class="pre">AUTOCAL</span></code> screen. The display will show the following options:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">volts</span></code>: DAC reference level. This determines the value sent to the DAC. It is also subtracted from the ADC readings to form the ‘delta’ plot pictured on the main screen.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set</span></code>: Calibration coefficient to be automatically adjusted. The utility will adjust the selected coefficients until the ‘delta’ plot on the main screen has been zeroed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">autozero</span></code>: Enable autozero. When set to <code class="docutils literal notranslate"><span class="pre">off</span></code>, nothing is adjusted. When set to <code class="docutils literal notranslate"><span class="pre">run</span></code>, the selected calibration coefficients will be adjusted. Usually, you switch to <code class="docutils literal notranslate"><span class="pre">run</span></code> until the values are zeroed, then switch it off again.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">write</span></code>: Write constants to non-volatile EEPROM and print them out the serial port.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Step 1</strong> ADC zero:</p>
<ul class="simple">
<li><p>With all jacks disconnected, set <code class="docutils literal notranslate"><span class="pre">volts=0</span></code>, <code class="docutils literal notranslate"><span class="pre">set=adc-zero</span></code>.</p></li>
<li><p>Switch <code class="docutils literal notranslate"><span class="pre">autozero=run</span></code> until the ‘delta’ plots hit zero. Switch back to <code class="docutils literal notranslate"><span class="pre">autozero=stop</span></code></p></li>
<li><p>You will notice the calibration equations at the bottom of the screen updated during the zeroing process.</p></li>
</ul>
</li>
<li><p><strong>Step 2</strong> ADC scale:</p>
<ul class="simple">
<li><p>Set an external precise voltage source to the desired test voltage, for example 3V.</p></li>
<li><p>With the first jack connected to your voltage source, set <code class="docutils literal notranslate"><span class="pre">volts=3</span></code>, <code class="docutils literal notranslate"><span class="pre">set=adc-scale</span></code>.</p></li>
<li><p>Switch <code class="docutils literal notranslate"><span class="pre">autozero=run</span></code> until the ‘delta’ plots hit zero.</p></li>
<li><p>Plug in the voltage source to the other jacks in sequence until they all also hit zero. Alternatively, you can just plug all the jacks into one voltage source at the same time, that’s up to you.</p></li>
<li><p>Switch back to <code class="docutils literal notranslate"><span class="pre">autozero=stop</span></code></p></li>
<li><p>Now the ADCs are calibrated, you can test the range by injecting different voltages and adjusting <code class="docutils literal notranslate"><span class="pre">volts</span></code> to move the reference.</p></li>
</ul>
</li>
<li><p><strong>Step 3</strong> DAC zero:</p>
<ul class="simple">
<li><p>Now that all the ADCs are calibrated, we can use the ADC calibration to calibrate the DACs.</p></li>
<li><p>Connect all outputs to inputs in loopback with 4 patch cables (i.e. output 0 to input 0, output 1 to input 1 and so on).</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">volts=0</span></code>, <code class="docutils literal notranslate"><span class="pre">set=dac-zero</span></code>. You will see see the DAC output zero offsets, as the ADCs were already zeroed.</p></li>
<li><p>Switch <code class="docutils literal notranslate"><span class="pre">autozero=run</span></code> until the ‘delta’ plots hit zero. Switch back to <code class="docutils literal notranslate"><span class="pre">autozero=stop</span></code></p></li>
</ul>
</li>
<li><p><strong>Step 4</strong> DAC scale:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">volts=3</span></code>, <code class="docutils literal notranslate"><span class="pre">set=dac-scale</span></code>. The ADC readings should already be pretty close to the target.</p></li>
<li><p>Switch <code class="docutils literal notranslate"><span class="pre">autozero=run</span></code> until the ‘delta’ plots hit zero. Switch back to <code class="docutils literal notranslate"><span class="pre">autozero=stop</span></code></p></li>
</ul>
</li>
<li><p><strong>Step 5</strong> Save the results</p>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">write</span></code> from the menu and turn the encoder to save the calibration to non-volatile EEPROM on the eurorack-pmod PCBA. The constants are also printed out the serial port. On switching to other bitstreams or returning to this bitstream, the previous calibration will be loaded from EEPROM.</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of now, the calibration constants are only loaded from EEPROM in bitstreams that have an SoC. If you want to use the calibration constants in a bitstream without a SoC, for now you can copy and paste the serial-port dump into the default calibration you will find in <code class="docutils literal notranslate"><span class="pre">eurorack_pmod.py</span></code>.</p>
</div>
<ul class="simple">
<li><p><strong>You are done!</strong> optionally, you can also tweak the cal constants from the <code class="docutils literal notranslate"><span class="pre">TWEAK-ADC</span></code> and <code class="docutils literal notranslate"><span class="pre">TWEAK-DAC</span></code> screens.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>During calibration, you may notice the DC offsets moving around ~10mV depending on whether the LEDs are on or off. Unfortunately there is no simple workaround for this as it seems the CODEC DC offsets depend on the CODEC supply voltage, despite us using a dedicated voltage reference. You may also see some higher offsets at high negative voltages. This is likely an artifact of us using the CODEC in an unsupported DC-coupled mode. In any case, it’s best to do the calibration assuming the LEDs are ON, as that is the state they will be in most of the time Tiliqua is being used. In the future, it should be possible to even calibrate out the effect of supply voltage changes to the CODEC, as the Tiliqua knows at all times how much power the audio PCBA should be consuming.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="dsp/cordic.html" class="btn btn-neutral float-left" title="Trigonometry / CORDIC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="hardware_design.html" class="btn btn-neutral float-right" title="Electrical Design" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024—2026, S. Holzapfel and Tiliqua contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>